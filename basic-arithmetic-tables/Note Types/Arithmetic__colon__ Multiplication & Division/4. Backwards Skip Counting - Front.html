<script>
var makeContent = (i) => [i * g + o, '<br>']
var MAX_ORDINAL = 10
</script>

<div id="container">
	<div id="skipco-mul-title" class="pale"><small>Repeatedly</small> subtract <b class="ans">{{text:Group}}</b></div>
	{{#Group Offset}}
	<div id="skipco-off-title" class="pale sublabel-s">Till <b>{{text:Group Offset}}</b></div>
	{{/Group Offset}}
	<br class="skipco-intro-br">
	<div class="skipco-seq"></div>
</div>

<div id="template">
	<div class="skipco skipco-item cloze-p"
			title="Press 'A' or 'D'">
		<div class="skipco-rv">
			<b class="skipco-v cloze ans"><span class="hint">&hellip;</span></b><span class="skipco-delim">&hairsp;,</span>
		</div>
		<div class="skipco-rn"><span class="skipco-n"></span></div>
	</div>
	<div class="skipco skipco-info">
		<div class="skipco-rv"><span class="skipco-v"></span><span class="skipco-delim">&hairsp;,</span></div>
		<div class="skipco-rn"><span class="skipco-n"></span></div>
	</div>
	<div class="skipco skipco-empty"></div>
</div>

<div id="fields">
	<div data-var=g>{{text:Group}}</div>
	<div data-var=o>{{text:Group Offset}}</div>
	<div data-var=s>{{text:Ordinal Start}}</div>
	<div data-var=e>{{text:Ordinal End}}</div>
</div>

<script>
/** SCOPE BEGIN **/ (() => {

document.querySelectorAll("#fields div[data-var]")
	.forEach(e => window[e.dataset.var] = parseInt(e.textContent) || 0)

function makeItem(i, template) {
	var [v, n] = makeContent(i)
	var el = template.cloneNode(true)
	el.querySelector(".skipco-v").insertAdjacentHTML('beforeend', v)
	el.querySelector(".skipco-n").insertAdjacentHTML('beforeend', n)
	return el
}

var item = document.querySelector("#template>.skipco-item")
var info = document.querySelector("#template>.skipco-info")
var empt = document.querySelector("#template>.skipco-empty")

var seq = document.querySelector(".skipco-seq")

//{{^Ordinal End}}
e = s
//{{/Ordinal End}}

//{{#Ordinal End}}
e = s + Math.min(e - s, 300)
//{{/Ordinal End}}

{
	let x = makeItem(e + 1, info)
	if (e >= MAX_ORDINAL) {
		x.classList.add("faded-l")
	//{{#Ordinal End}}
	} else if (e - s > 3) {
		seq.appendChild(empt.cloneNode(true))
	//{{/Ordinal End}}
	}
	seq.appendChild(x)
}

//{{^Ordinal End}}
seq.appendChild(makeItem(s, item))
//{{/Ordinal End}}

{
	//{{#Ordinal End}}
	let c = seq.childElementCount
	for (let i = e; i >= s; i--) {
		if (!(++c % 7)) {
			seq.appendChild(empt.cloneNode(true))
			seq.appendChild(empt.cloneNode(true))
			c++; c++
		}
		seq.appendChild(makeItem(i, item));
	}
	//{{/Ordinal End}}

	if (s == 1) {
		let x = makeItem(0, item)
		x.classList.add("faded-l")
		seq.appendChild(x)
	} else if (s) {
		let x = makeItem(s - 1, info)
		//{{#Ordinal End}}
		if (!(++c % 7)) {
			seq.appendChild(empt.cloneNode(true))
			seq.appendChild(empt.cloneNode(true))
		}
		//{{/Ordinal End}}
		seq.appendChild(x)
	}
}

//{{#Group Offset}}
var skipOffsetTitle = document.getElementById("skipco-off-title")
if (!o) {
	skipOffsetTitle.classList.add("hidden")
} else if (s > 1) {
	document.getElementById("skipco-off-title")
		.classList.add("cloze", "last")
}
//{{/Group Offset}}

/** SCOPE END **/ })()

// ---

{
	let excl = new Set(document.querySelectorAll(".cloze-p .cloze"))
	document.querySelectorAll(".cloze-p, .cloze").forEach(el => {
		if (excl.has(el)) return
		el.ondblclick = ev => toggleCloze(el, undefined, ev)
		el.onmousedown = ev => preventDblClickSelect(ev)
	})
}

document.onkeydown = function(e) {
	// Handle only if no other modifier keys are held except SHIFT
	if (e.ctrlKey || e.altKey || e.metaKey) {
		return
	}
	switch (e.key) {
		case 'q': case 'Q':
		case 'a': case 'A': {
			e.preventDefault()
			let q = document.querySelectorAll("#container .cloze.revealed.last")
			if (!q.length)
				q = document.querySelectorAll("#container .cloze.revealed")
			q = q[q.length-1]
			if (q) toggleCloze(q.closest(".cloze-p") || q, false)
			break
		}
		case 'w': case 'W':
		case 'd': case 'D': {
			e.preventDefault()
			let q = document.querySelector("#container .cloze:not(.revealed):not(.last)")
			if (!q) q = document.querySelector("#container .cloze:not(.revealed)")
			if (q) toggleCloze(q.closest(".cloze-p") || q, true)
			break
		}
	}
}

function toggleCloze(el, force, ev) {
	if (!el) return
	if (ev) {
		if (ev.ctrlKey) return
		ev.preventDefault()
	}
	if (el.classList.contains("cloze"))
		el.classList.toggle("revealed", force)
	if (el.classList.contains("cloze-p"))
		el.querySelectorAll(".cloze")
			.forEach(cel => cel.classList.toggle("revealed", force))
}

function preventDblClickSelect(e) {
	// Prevents double click selection
	// See, https://stackoverflow.com/a/43321596/1906724
	if (e.detail > 1 && !e.ctrlKey)
		e.preventDefault()
}
</script>
